---
title: Almacenamiento de los resultados del examen de evaluación de vulnerabilidad en una cuenta de almacenamiento accesible detrás de firewalls y redes virtuales
description: Se proporcionan instrucciones sobre cómo almacenar exámenes de evaluación de vulnerabilidad (VA) en una cuenta de almacenamiento a la que se puede tener acceso a través de un firewall o una red virtual.
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 12/01/2020
ms.openlocfilehash: bc2fb5032376f96319d653b17c73596b28033aa8
ms.sourcegitcommit: 079426f4980fadae9f320977533b5be5c23ee426
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/04/2021
ms.locfileid: "129418449"
---
# <a name="store-vulnerability-assessment-scan-results-in-a-storage-account-accessible-behind-firewalls-and-vnets"></a>Almacenamiento de los resultados del examen de evaluación de vulnerabilidad en una cuenta de almacenamiento accesible detrás de firewalls y redes virtuales
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

Si está limitando el acceso a su cuenta de almacenamiento en Azure para determinados servicios o redes virtuales, deberá habilitar la configuración adecuada para que los exámenes de evaluación de vulnerabilidad (VA) para SQL Database o instancias administradas tengan acceso a dicha cuenta de almacenamiento.

## <a name="prerequisites"></a>Requisitos previos

El servicio de evaluación de vulnerabilidades de SQL necesita permiso de acceso a la cuenta de almacenamiento para guardar la línea de base y examinar los resultados.  Existen tres métodos: 
- **Uso de la clave de la cuenta de almacenamiento**: Azure crea la clave SAS y la guarda (aunque no se guarda la clave de cuenta).
- **Uso de la clave SAS de almacenamiento**: la clave SAS debe tener los permisos: Escritura | Enumeración | Lectura | Eliminación.
- **Uso de la identidad administrada de SQL Server**: SQL Server debe tener una identidad administrada. La cuenta de almacenamiento debe tener una asignación de roles para la identidad administrada de SQL como [Colaborador de datos de blobs de almacenamiento](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor). Al aplicar la configuración, los campos de evaluación de vulnerabilidades storageContainerSasKey y storageAccountAccessKey deben estar vacíos. Cuando el almacenamiento está detrás de un firewall o de una red virtual, se requiere la identidad administrada de SQL. 

Cuando se usa Azure Portal para guardar la configuración de evaluación de vulnerabilidades de SQL, Azure comprueba si tiene permiso para realizar una nueva asignación de roles para la identidad administrada como [Colaborador de datos de blobs de almacenamiento](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor) en el almacenamiento. Si se asignan permisos, Azure usa la identidad administrada de SQL Server; de lo contrario, Azure usa el método de clave. 

## <a name="enable-azure-sql-database-va-scanning-access-to-the-storage-account"></a>Habilitación del acceso de los exámenes de VA de Azure SQL Database a la cuenta de almacenamiento

Si ha configurado la cuenta de almacenamiento de VA para que solo sea accesible mediante determinados servicios o redes, deberá asegurarse de que los exámenes de VA para Azure SQL Database puedan almacenar los exámenes en la cuenta de almacenamiento. Puede usar la cuenta de almacenamiento existente o crear una nueva para almacenar los resultados del examen de VA de todas las bases de datos en su [servidor SQL lógico](logical-servers.md).

> [!NOTE]
> El servicio de evaluación de vulnerabilidades no puede acceder a las cuentas de almacenamiento protegidas con firewalls o redes virtuales si necesitan claves de acceso de almacenamiento.

Vaya al **grupo de recursos** que contenga la cuenta de almacenamiento y obtenga acceso al panel **Cuenta de almacenamiento**. En **Configuración**, seleccione **Firewall y redes virtuales**.

Asegúrese de que la opción **Permitir que los servicios de Microsoft de confianza accedan a esta cuenta de almacenamiento** está habilitada.

:::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-allow-microsoft-services.png" alt-text="Captura de pantalla que muestra el cuadro de diálogo Firewall y redes virtuales, con la opción Permitir que los servicios de Microsoft de confianza accedan a esta cuenta de almacenamiento seleccionada.":::

Para saber qué cuenta de almacenamiento se usa, vaya al panel de **SQL Server** en [Azure Portal](https://portal.azure.com) y, en **Seguridad**, seleccione **Security Center**.

:::image type="content" source="../database/media/azure-defender-for-sql/va-storage.png" alt-text="Configuración de la evaluación de vulnerabilidades":::

> [!NOTE]
> Puede configurar alertas por correo electrónico para notificar a los usuarios de su organización que consulten o accedan a los informes de examen. Para ello, asegúrese de que tiene permisos de administrador de seguridad de SQL y de lector de datos de Storage Blob.

## <a name="store-va-scan-results-for-azure-sql-managed-instance-in-a-storage-account-that-can-be-accessed-behind-a-firewall-or-vnet"></a>Almacenamiento de los resultados del examen de VA para Instancia administrada de Azure SQL en una cuenta de almacenamiento a la que se puede tener acceso detrás de un firewall o una red virtual

Dado que Instancia administrada no es un servicio de Microsoft de confianza y que tiene una red virtual diferente a la cuenta de almacenamiento, la ejecución del examen de VA producirá un error.

Para admitir los exámenes de VA en Instancias administradas, siga estos pasos:

1. En el panel **Instancia administrada de SQL**, en el título **Información general**, haga clic en el vínculo **Red virtual o subred**. De esta forma, se le dirige al panel **Red virtual**.

   :::image type="content" source="../managed-instance/media/public-endpoint-configure/mi-overview.png" alt-text="mi-overview2":::

1. En **Configuración**, seleccione **Subredes**. En el panel nuevo, haga clic en **Subred** para agregar una subred y deléguela a *Microsoft.Sql\managedInstance*. Para obtener más información, consulte [Administración de subredes](../../virtual-network/virtual-network-manage-subnet.md).

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-subnets.png" alt-text="Captura de pantalla que muestra una subred en la que se ha delegado Microsoft.sql\managedInstance.":::

1. En el panel **Red virtual**, en **Configuración**, seleccione **Puntos de conexión de servicio**. En el panel nuevo, haga clic en **Agregar** y agregue el servicio *Microsoft.Storage* como nuevo punto de conexión de servicio. Asegúrese de que se ha seleccionado la subred *ManagedInstance*. Haga clic en **Agregar**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-service-endpoint.png" alt-text="Captura de pantalla que muestra Agregar puntos de conexión de servicio, donde se agrega el servicio Microsoft.Storage como punto de conexión.":::

1. Vaya a la **cuenta de almacenamiento** que ha seleccionado para almacenar los exámenes de VA. En **Configuración**, seleccione **Firewall y redes virtuales**. Haga clic en **Agregar red virtual existente**. Seleccione la red virtual y la subred de la instancia administrada y haga clic en **Agregar**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-firewall.png" alt-text="Captura de pantalla que muestra el panel Firewall y redes virtuales, que contiene el vínculo Agregar red virtual existente.":::

Ahora debería poder almacenar los exámenes de VA para Instancias administradas en la cuenta de almacenamiento.

## <a name="troubleshoot-vulnerability-assessment-scan-related-issues"></a>Solución de problemas relacionados con el examen de evaluación de vulnerabilidades 

Solución de problemas comunes relacionados con los exámenes de evaluación de vulnerabilidades.

### <a name="failure-to-save-vulnerability-assessment-settings"></a>No se pudo guardar la configuración de la evaluación de vulnerabilidad.

Es posible que no pueda guardar los cambios en la configuración de evaluación de vulnerabilidades si la cuenta de almacenamiento no cumple algunos requisitos previos o si no tiene permisos suficientes.

#### <a name="storage-account-requirements"></a>Requisitos de la cuenta de almacenamiento

La cuenta de almacenamiento en la que se guardan los resultados del examen de evaluación de vulnerabilidades debe cumplir los siguientes requisitos:

- **Tipo**: StorageV2 (de uso general V2) o Storage (de uso general V1)
- **Rendimiento**: Estándar (solo)
- **Región**: el almacenamiento debe estar en la misma región que la instancia de Azure SQL Server.

Si no se cumple alguno de estos requisitos, se produce un error al guardar los cambios en la configuración de evaluación de vulnerabilidades.

#### <a name="permissions"></a>Permisos 

Se requieren los permisos siguientes para guardar los cambios en la configuración de evaluación de vulnerabilidades:

- Administrador de seguridad SQL
- Lector de datos de blobs de almacenamiento

Para establecer una nueva asignación de roles, hace falta el acceso de propietario o administrador de usuarios a la cuenta de almacenamiento y los permisos siguientes:

- Propietario de datos de blobs de almacenamiento

### <a name="storage-account-isnt-visible-for-selection-in-vulnerability-assessment-settings"></a>La cuenta de almacenamiento no está visible para la selección en la configuración de evaluación de vulnerabilidades

Es posible que la cuenta de almacenamiento no aparezca en el selector de cuentas de almacenamiento por varias razones:

- La cuenta de almacenamiento que busca no está en la suscripción seleccionada.
- La cuenta de almacenamiento que busca no se encuentra en la misma región que Azure SQL Server.
- No tiene permisos de Microsoft.Storage/storageAccounts/read en la cuenta de almacenamiento.

### <a name="failure-to-open-an-email-link-for-scan-results-or-cant-view-scan-results"></a>Error al abrir el vínculo de correo electrónico de los resultados del examen o no se pueden ver los resultados del examen

Es posible que no pueda abrir un vínculo de un correo electrónico de notificación sobre los resultados del examen o que no pueda ver los resultados del examen si no tiene los permisos necesarios o si usa un explorador que no admite la apertura o visualización de los resultados del examen.

#### <a name="permissions"></a>Permisos

Los siguientes permisos son necesarios para abrir vínculos en notificaciones por correo electrónico sobre los resultados del examen o para ver los resultados del examen:

- Administrador de seguridad SQL
- Lector de datos de blobs de almacenamiento

#### <a name="browser-requirements"></a>Requisitos del explorador

El explorador Firefox no admite la apertura o visualización de la vista de resultados del examen. Se recomienda usar Chrome o Microsoft Edge para ver los resultados del examen de evaluación de vulnerabilidades.

## <a name="next-steps"></a>Pasos siguientes

- [Evaluación de vulnerabilidad](sql-vulnerability-assessment.md)
- [Creación de una cuenta de Azure Storage](../../storage/common/storage-account-create.md)
- [Azure Defender for SQL](azure-defender-for-sql.md)
