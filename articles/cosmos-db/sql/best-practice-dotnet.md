---
title: Procedimientos recomendados de Azure Cosmos DB para el SDK de .NET v3
description: Obtenga información sobre los procedimientos recomendados para usar el SDK de .NET v3 de Azure Cosmos DB
author: StefArroyo
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: how-to
ms.date: 08/26/2021
ms.author: esarroyo
ms.openlocfilehash: b07162b95419a73be4bdecc5ff3160ded1c2a0e5
ms.sourcegitcommit: 40866facf800a09574f97cc486b5f64fced67eb2
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/30/2021
ms.locfileid: "123219630"
---
# <a name="best-practices-for-azure-cosmos-db-net-sdk"></a>Procedimientos recomendados para el SDK de .NET de Azure Cosmos DB
[!INCLUDE[appliesto-sql-api](../includes/appliesto-sql-api.md)]

Este artículo le guía por los procedimientos recomendados para usar el SDK de .NET de Azure Cosmos DB. Seguir estos procedimientos le ayudará a mejorar su latencia, disponibilidad y mejorar el rendimiento general. 

¡Vea el vídeo siguiente para más información sobre el uso del SDK de .NET de un ingeniero de Cosmos DB!


> [!VIDEO https://www.youtube.com/embed/McZIQhZpvew?start=118]
>

## <a name="checklist"></a>Lista de comprobación
|Activada  | Tema  |Detalles o vínculos  |
|---------|---------|---------|
|<input type="checkbox"/> |    Versión del SDK    |   Use siempre la [versión más reciente](sql-api-sdk-dotnet-standard.md) del SDK de Cosmos DB disponible para obtener un rendimiento óptimo.     |
| <input type="checkbox"/>   |    Cliente singleton     |       Use una [sola instancia](/dotnet/api/microsoft.azure.cosmos.cosmosclient?view=azure-dotnet&preserve-view=true) de `CosmosClient`durante la vigencia de la aplicación para [mejorar el rendimiento](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage).     |
| <input type="checkbox"/>  |     Regions     |   Asegúrese de ejecutar la aplicación en la misma [región de Azure](../distribute-data-globally.md) que su cuenta de Azure Cosmos DB, siempre que sea posible, para reducir la latencia. Habilite de 2 a 4 regiones y replique las cuentas en varias regiones para obtener la [máxima disponibilidad](../distribute-data-globally.md). Para cargas de trabajo de producción, habilite la [conmutación automática por error](../how-to-manage-database-account.md#configure-multiple-write-regions). En ausencia de esta configuración, la cuenta experimentará la pérdida de la disponibilidad de escritura durante toda la interrupción de la región de escritura, ya que la conmutación por error manual no se realizará correctamente debido a la falta de conectividad con la región. Para aprender a agregar varias regiones mediante el SDK de .NET, visite [este vínculo](tutorial-global-distribution-sql-api.md).   |
| <input type="checkbox"/>   |   Disponibilidad y conmutaciones por error     |  Establezca [ApplicationPreferredRegions](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationpreferredregions?view=azure-dotnet&preserve-view=true) o [ApplicationRegion](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion?view=azure-dotnet&preserve-view=true) en el SDK v3 y [PreferredLocations](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations?view=azure-dotnet&preserve-view=true) en el SDK v2 mediante la  [lista de regiones preferidas](./tutorial-global-distribution-sql-api.md?tabs=dotnetv3%2capi-async#preferred-locations). Durante las conmutaciones por error, las operaciones de escritura se envían a la región de escritura actual y todas las lecturas se envían a la primera región de la lista de regiones preferidas. Para más información sobre la mecánica de conmutación por error regional, consulte la [guía de solución de problemas de disponibilidad](troubleshoot-sdk-availability.md). |
|  <input type="checkbox"/> |    CPU     |  Es posible que experimente problemas de conectividad o disponibilidad debido a falta de recursos en el equipo cliente. Supervise el uso de la CPU en los nodos que ejecutan el cliente de Azure Cosmos DB y escale vertical u horizontalmente si el uso es muy alto.      |
| <input type="checkbox"/>   |    Hosting      |   Use el procesamiento de [host de 64 bits de Windows](performance-tips.md#hosting) para obtener el mejor rendimiento, siempre que sea posible.       |
| <input type="checkbox"/> |    Modos de conectividad    |    Use el [modo Directo](sql-sdk-connection-modes.md) para obtener el mejor rendimiento.  Para instrucciones sobre cómo hacerlo, consulte la [documentación del SDK V3](performance-tips-dotnet-sdk-v3-sql.md#networking) o la [documentación del SDK V2](performance-tips.md#networking).|
|<input type="checkbox"/>  |    Redes   | Si usa una máquina virtual para ejecutar la aplicación, habilite las [redes aceleradas](../../virtual-network/create-vm-accelerated-networking-powershell.md) en la VM para ayudar con los cuellos de botella debidos al tráfico elevado y reducir la latencia o la inestabilidad de la CPU. También puede considerar la posibilidad de usar una máquina virtual de un extremo superior en la que el uso máximo de CPU sea inferior al 70 %.    |
|<input type="checkbox"/> |  Agotamiento de puertos efímeros      | Para las conexiones dispersas o esporádicas, establecemos [`IdleConnectionTimeout`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.idletcpconnectiontimeout?view=azure-dotnet&preserve-view=true) y [`PortReuseMode`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.portreusemode?view=azure-dotnet&preserve-view=true) en `PrivatePortPool`. La propiedad `IdleConnectionTimeout` ayuda a controlar el tiempo que se cierran las conexiones sin usar. Esto reducirá el número de conexiones no utilizadas. De forma predeterminada, las conexiones inactivas se mantienen abiertas indefinidamente. El valor establecido debe ser mayor o igual que 10 minutos. Se recomienda usar valores entre 20 minutos y 24 horas.  La propiedad `PortReuseMode` permite al SDK usar un pequeño grupo de puertos efímeros para varios puntos de conexión de destino de Azure Cosmos DB.    |
|<input type="checkbox"/> |  Uso de Async/Await     |  Evite las llamadas de bloqueo: `Task.Result`, `Task.Wait` y `Task.GetAwaiter().GetResult()`. Toda la pila de llamadas es asincrónica para beneficiarse de los patrones [async/await](/dotnet/csharp/programming-guide/concepts/async/). Muchas llamadas de bloqueo sincrónicas conducen a la [escasez del grupo de subprocesos](/archive/blogs/vancem/diagnosing-net-core-threadpool-starvation-with-perfview-why-my-service-is-not-saturating-all-cores-or-seems-to-stall) y a tiempos de respuesta degradados. |
|<input type="checkbox"/>  |   Tiempos de espera de un extremo a otro | Para obtener tiempos de espera de un extremo a otro, deberá usar los parámetros `RequestTimeout` y `CancellationToken`. Para obtener más detalles sobre los tiempos de espera con Cosmos DB [visite este vínculo](troubleshoot-dot-net-sdk-request-timeout.md). |
|<input type="checkbox"/>  |   Lógica de reintento      |   Un error transitorio es un error que tiene una causa subyacente que pronto se resuelve por él mismo. Las aplicaciones que se conectan a la base de datos deberían crearse de modo que contemplen esos errores transitorios. Para controlarlos, implemente una lógica de reintento en el código en lugar de mostrarlas a los usuarios como errores de aplicación. El SDK tiene lógica integrada para controlar estos errores transitorios en solicitudes que se pueden reintentar, como operaciones de lectura o consulta. El SDK no reintentará las escrituras en caso de errores transitorios, ya que las escrituras no son idempotentes. El SDK permite a los usuarios configurar la lógica de reintento para las limitaciones. Para más información sobre qué errores reintentar, [visite este vínculo](troubleshoot-dot-net-sdk.md#retry-logics). |
|<input type="checkbox"/>  |     Almacenamiento en caché de nombres de base de datos o colección    |    Durante el inicio, recupere los nombres de las bases de datos y los contenedores de la configuración o almacénelos en memoria caché. Las llamadas como `ReadDatabaseAsync` o `ReadDocumentCollectionAsync` y `CreateDatabaseQuery` o `CreateDocumentCollectionQuery` darán lugar a llamadas de metadatos al servicio, que consumen desde el límite de RU reservado por el  sistema. `CreateIfNotExist` también debe usarse solo una vez para configurar la base de datos. En general, estas operaciones rara vez deben realizarse.       |
|<input type="checkbox"/> |     Compatibilidad masiva      |     En escenarios en los que es posible que no necesite optimizar la latencia, se recomienda habilitar la [compatibilidad masiva](https://devblogs.microsoft.com/cosmosdb/introducing-bulk-support-in-the-net-sdk/) para volcar grandes volúmenes de datos.    |
| <input type="checkbox"/>  |     Consultas en paralelo     |    El SDK de Cosmos DB admite la [ejecución de consultas en paralelo](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage) para mejorar la latencia y el rendimiento de las consultas.  Se recomienda establecer la propiedad `MaxConcurrency` dentro de `QueryRequestsOptions` en el número de particiones que tiene. Si no conoce el número de particiones, empiece por usar `int.MaxValue`, que le dará la mejor latencia. A continuación, reduzca el número hasta que se ajuste a las restricciones de recursos del entorno para evitar problemas elevados de CPU. Además, establezca `MaxBufferedItemCount` en el número esperado de resultados devueltos para limitar el número de resultados capturados previamente. |
| <input type="checkbox"/> |     Retrocesos de pruebas de rendimiento      |    Al realizar pruebas en la aplicación, debe implementar los retrocesos a intervalos [`RetryAfter`](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage). Respetar el retroceso ayuda a garantizar una cantidad mínima de tiempo en espera entre reintentos.   |
|  <input type="checkbox"/>   |   Indización     |   La directiva de indexación de Azure Cosmos DB también le permite especificar las rutas de acceso de documentos que se van a incluir o excluir de la indexación mediante rutas de acceso de indexación (IndexingPolicy.IncludedPaths e IndexingPolicy.ExcludedPaths).  Asegúrese de excluir las rutas de acceso sin utilizar de la indexación para acelerar las escrituras.  Para obtener un ejemplo sobre cómo crear índices mediante el SDK, visite [este vínculo](performance-tips-dotnet-sdk-v3-sql.md#indexing-policy).   |
|  <input type="checkbox"/>   |    Tamaño del documento  |    El cargo de la solicitud de una operación determinada se correlaciona directamente con el tamaño del documento. Se recomienda reducir el tamaño de los documentos, ya que las operaciones en documentos grandes cuestan más que las operaciones en documentos más pequeños.      |
| <input type="checkbox"/>   |     Aumentar el número de subprocesos o tareas    |    Como las llamadas a Azure Cosmos DB se realizan a través de la red, es posible que tenga que cambiar el grado de simultaneidad de las solicitudes para que la aplicación cliente dedique un tiempo mínimo a esperar entre solicitudes. Por ejemplo, si usa la [biblioteca TPL de .NET](/dotnet/standard/parallel-programming/task-parallel-library-tpl), cree en el orden de cientos de tareas que leen o escriben en Azure Cosmos DB.     |
|  <input type="checkbox"/> |    Habilitación de métricas de consulta     |  Para el registro adicional de las ejecuciones de consultas de back-end, puede habilitar las métricas de consulta de SQL mediante nuestro SDK de .NET. Para instrucciones sobre cómo recopilar métricas de consulte de SQL, [visite este vínculo](profile-sql-api-query.md).    |
|  <input type="checkbox"/>    | Registro del SDK   | Use el registro del SDK para capturar información de diagnóstico adicional y solucionar problemas de latencia.  Registre la [cadena de diagnóstico en](/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet&preserve-view=true) el SDK V2 o [`Diagnostics`](/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics?view=azure-dotnet&preserve-view=true) en el SDK v3 para información de diagnóstico de Cosmos más detallada de la solicitud actual al servicio. Como ejemplo de caso de uso, capture diagnósticos en cualquier excepción y en operaciones completadas si `Diagnostics.ElapsedTime` es mayor que un valor de umbral designado (es decir, si tiene un Acuerdo de Nivel de Servicio de 10 segundos, capture los diagnósticos cuando `ElapsedTime` > 10 segundos). Se recomienda usar solo estos diagnósticos durante las pruebas de rendimiento.     |

## <a name="best-practices-when-using-gateway-mode"></a>Procedimientos recomendados al usar el modo de puerta de enlace
Aumente `System.Net MaxConnections` por host cuando use el modo de puerta de enlace. Las solicitudes de Azure Cosmos DB se realizan mediante HTTPS o REST cuando se usa el modo de puerta de enlace. Están sujetas al límite de conexiones predeterminado por nombre de host o dirección IP. Es posible que tenga que establecer `MaxConnections` en un valor superior (de 100 a 1000) para que la biblioteca cliente pueda utilizar varias conexiones simultáneas con Azure Cosmos DB. En el SDK de .NET 1.8.0 y versiones posteriores, el valor predeterminado de `ServicePointManager.DefaultConnectionLimit` es 50. Para cambiar el valor, puede establecer `Documents.Client.ConnectionPolicy.MaxConnectionLimit` en un valor superior.

## <a name="best-practices-for-write-heavy-workloads"></a>Prácticas recomendadas para cargas de trabajo de escritura intensiva
En el caso de cargas de trabajo con cargas útiles de operaciones de creación intensivas, establezca la opción de solicitud `EnableContentResponseOnWrite` en `false`. El servicio ya no devolverá al SDK el recurso creado o actualizado. Normalmente, dado que la aplicación tiene el objeto que se crea, no necesita que el servicio lo devuelva. Todavía se puede acceder a los valores de encabezado, como un cargo de solicitud. Deshabilitar el contenido de la respuesta puede ayudar a mejorar el rendimiento, porque el SDK ya no tendrá que asignar memoria ni serializar el cuerpo de la respuesta. También reduce el uso de ancho de banda de red para mejorar más el rendimiento.

## <a name="next-steps"></a>Pasos siguientes
Para obtener una aplicación de ejemplo que se usa para evaluar Azure Cosmos DB en escenarios de alto rendimiento en algunos equipos del cliente, consulte [Rendimiento y pruebas de escalado con Azure Cosmos DB](performance-testing.md).

Para más información sobre cómo diseñar la aplicación para escalarla y obtener un alto rendimiento, consulte [Partición y escalado en Azure Cosmos DB](../partitioning-overview.md).

¿Intenta planear la capacidad de una migración a Azure Cosmos DB? Para ello, puede usar información sobre el clúster de base de datos existente.
* Si lo único que sabe es el número de núcleos virtuales y servidores del clúster de bases de datos existente, lea sobre el [cálculo de unidades de solicitud mediante núcleos o CPU virtuales](../convert-vcore-to-request-unit.md). 
* Si conoce las tasas de solicitudes típicas de la carga de trabajo de la base de datos actual, obtenga información sobre el [cálculo de unidades de solicitud mediante la herramienta de planeamiento de capacidad de Azure Cosmos DB](estimate-ru-with-capacity-planner.md).
